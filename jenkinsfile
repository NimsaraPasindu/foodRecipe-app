pipeline {
  agent any

  environment {
    DOCKER_USER = "nimsara2000"
    FRONTEND_IMAGE = "${DOCKER_USER}/mern-frontend"
    BACKEND_IMAGE = "${DOCKER_USER}/mern-backend"
    TAG = "${BUILD_NUMBER}"
  }

  stages {
    stage('Checkout') {
      steps {
        git url: 'https://github.com/NimsaraPasindu/foodRecipe-app.git' 
      }
    }

    stage('Trivy Scan') {
      steps {
        sh 'trivy fs . || true' // don't fail build if vulnerabilities
      }
    }

    stage('Build Docker Images') {
      steps {
        sh '''
          docker build -t $FRONTEND_IMAGE:$TAG ./frontend
          docker build -t $BACKEND_IMAGE:$TAG ./backend
        '''
      }
    }

    stage('Login to Docker Hub & Push Images') {
      steps {
        withCredentials([usernamePassword(credentialsId: 'dockerhub-creds', usernameVariable: 'DOCKER_USERNAME', passwordVariable: 'DOCKER_PASSWORD')]) {
          sh '''
            echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin

            docker push $FRONTEND_IMAGE:$TAG
            docker push $BACKEND_IMAGE:$TAG
          '''
        }
      }
    }

    stage('Deploy to AKS via Helm') {
      steps {
        sh '''
          az aks get-credentials --name mern-app --resource-group foodRecipe

          helm upgrade --install myapp ./helm/myapp \
            --set frontend.image.repository=$FRONTEND_IMAGE \
            --set frontend.image.tag=$TAG \
            --set backend.image.repository=$BACKEND_IMAGE \
            --set backend.image.tag=$TAG
        '''
      }
    }
  }
}
